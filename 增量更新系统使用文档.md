# å¢é‡æ›´æ–°ç³»ç»Ÿä½¿ç”¨æ–‡æ¡£

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

å¢é‡æ›´æ–°ç³»ç»Ÿç”±ä¸¤ä¸ªæ ¸å¿ƒæ¨¡å—ç»„æˆï¼š
- **UpdateBuilder**: æ„å»ºæ›´æ–°åŒ…ï¼Œç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯å’Œå¢é‡æ›´æ–°æ–‡ä»¶
- **UpdateManager**: ç®¡ç†æ›´æ–°æµç¨‹ï¼Œå¤„ç†ä¸‹è½½ã€éªŒè¯å’Œåº”ç”¨æ›´æ–°

## ğŸ—ï¸ UpdateBuilder - æ›´æ–°åŒ…æ„å»ºå™¨

### åŠŸèƒ½ç‰¹æ€§
- âœ… è‡ªåŠ¨æ‰«æåº”ç”¨æ–‡ä»¶å¹¶è®¡ç®—å“ˆå¸Œå€¼
- âœ… æ”¯æŒå¤§æ–‡ä»¶åˆ†å—å¤„ç†ï¼ˆ50MBåˆ†å—ï¼‰
- âœ… ç”Ÿæˆå®Œæ•´ç‰ˆæœ¬å’Œå¢é‡æ›´æ–°ä¿¡æ¯
- âœ… æ”¯æŒæ¨¡å‹æ–‡ä»¶æ›´æ–°ç®¡ç†
- âœ… å¿½ç•¥ä¸å¿…è¦çš„æ–‡ä»¶ï¼ˆç¼“å­˜ã€æ—¥å¿—ç­‰ï¼‰

### åŸºæœ¬ä½¿ç”¨

#### 1. å‘½ä»¤è¡Œä½¿ç”¨
```bash
# æ„å»ºå®Œæ•´æ›´æ–°åŒ…
python -m src.utils.UpdateBuilder ./app 1.2.0 --changelog "ä¿®å¤äº†é‡è¦bug"

# æ„å»ºå¢é‡æ›´æ–°åŒ…
python -m src.utils.UpdateBuilder ./app 1.2.0 --previous 1.1.0 --changelog "æ–°å¢åŠŸèƒ½"

# æŒ‡å®šè¾“å‡ºç›®å½•
python -m src.utils.UpdateBuilder ./app 1.2.0 --output ./releases
```

#### 2. Python APIä½¿ç”¨
```python
from src.utils.UpdateBuilder import UpdateBuilder

# åˆ›å»ºæ„å»ºå™¨
builder = UpdateBuilder("./app", "./releases")

# ç”Ÿæˆæ›´æ–°ä¿¡æ¯
update_info = builder.generate_update_json(
    version="1.2.0",
    changelog="ä¿®å¤äº†é‡è¦bug",
    previous_version="1.1.0"
)

# ä¿å­˜æ›´æ–°ä¿¡æ¯
json_path = builder.save_update_json(update_info)

# åˆ›å»ºå®Œæ•´æ›´æ–°åŒ…
current_json, incremental_json = builder.create_update_package(
    version="1.2.0",
    changelog="ä¿®å¤äº†é‡è¦bug",
    previous_version="1.1.0"
)
```

### è¾“å‡ºæ–‡ä»¶ç»“æ„
```
releases/
â”œâ”€â”€ update_1.2.0.json          # å®Œæ•´ç‰ˆæœ¬ä¿¡æ¯
â”œâ”€â”€ incremental_1.2.0.json     # å¢é‡æ›´æ–°ä¿¡æ¯
â”œâ”€â”€ models_1.2.0.json          # æ¨¡å‹æ›´æ–°ä¿¡æ¯
â””â”€â”€ app_1.2.0/                 # åº”ç”¨æ–‡ä»¶å‰¯æœ¬
    â”œâ”€â”€ main.py
    â”œâ”€â”€ src/
    â””â”€â”€ ...
```

### æ›´æ–°ä¿¡æ¯JSONæ ¼å¼

#### å®Œæ•´ç‰ˆæœ¬ä¿¡æ¯ (update_1.2.0.json)
```json
{
  "version": "1.2.0",
  "previous_version": "1.1.0",
  "build_time": "2025-01-15T10:30:00",
  "changelog": "ä¿®å¤äº†é‡è¦bug",
  "total_files": 156,
  "total_size": 52428800,
  "files": [
    {
      "path": "main.py",
      "hash": "a1b2c3d4e5f6...",
      "size": 1024,
      "modified": "2025-01-15T10:25:00"
    },
    {
      "path": "models/large_model.gguf",
      "hash": "f6e5d4c3b2a1...",
      "size": 104857600,
      "chunks": ["chunk1_hash", "chunk2_hash"],
      "chunk_size": 52428800
    }
  ]
}
```

#### å¢é‡æ›´æ–°ä¿¡æ¯ (incremental_1.2.0.json)
```json
{
  "version": "1.2.0",
  "previous_version": "1.1.0",
  "update_type": "incremental",
  "changed_files": [
    {
      "path": "main.py",
      "hash": "a1b2c3d4e5f6...",
      "size": 1024
    }
  ],
  "new_files": [
    {
      "path": "new_feature.py",
      "hash": "b2c3d4e5f6a1...",
      "size": 2048
    }
  ],
  "deleted_files": [
    {
      "path": "old_file.py"
    }
  ],
  "total_changes": 3,
  "total_size": 3072
}
```

## ğŸ”„ UpdateManager - æ›´æ–°ç®¡ç†å™¨

### åŠŸèƒ½ç‰¹æ€§
- âœ… è‡ªåŠ¨æ£€æŸ¥åº”ç”¨å’Œæ¨¡å‹æ›´æ–°
- âœ… æ”¯æŒå¤šé•œåƒä¸‹è½½å’Œæ–­ç‚¹ç»­ä¼ 
- âœ… æ–‡ä»¶å®Œæ•´æ€§éªŒè¯
- âœ… è‡ªåŠ¨å¤‡ä»½å’Œæ¢å¤
- âœ… é…ç½®åŒ–ç®¡ç†

### åŸºæœ¬ä½¿ç”¨

#### 1. åˆå§‹åŒ–é…ç½®
```python
from src.utils.UpdateManager import UpdateManager

# åˆ›å»ºæ›´æ–°ç®¡ç†å™¨
update_manager = UpdateManager("my_update_config.json")

# é…ç½®æ›´æ–°æº
update_manager.update_config.update({
    "version_url": "https://your-cdn.com/version.json",
    "current_version": "1.1.0",
    "auto_download": False,
    "backup_before_update": True,
    "mirror_urls": [
        "https://mirror1.example.com/",
        "https://mirror2.example.com/"
    ]
})

# ä¿å­˜é…ç½®
update_manager.save_config()
```

#### 2. æ£€æŸ¥æ›´æ–°
```python
# æ£€æŸ¥åº”ç”¨æ›´æ–°
app_update = update_manager.check_app_update()
if app_update and app_update.get("has_update"):
    print(f"å‘ç°æ–°ç‰ˆæœ¬: {app_update['remote_version']}")
    print(f"æ›´æ–°æ—¥å¿—: {app_update['changelog']}")

# æ£€æŸ¥æ¨¡å‹æ›´æ–°
model_updates = update_manager.check_model_update()
for model_name, update_info in model_updates.items():
    if update_info.get("has_update"):
        print(f"æ¨¡å‹ {model_name} æœ‰æ›´æ–°")
```

#### 3. ä¸‹è½½æ›´æ–°
```python
def progress_callback(url, progress, downloaded, total):
    print(f"ä¸‹è½½è¿›åº¦: {progress:.1f}% ({downloaded//1024//1024}MB/{total//1024//1024}MB)")

def error_callback(error):
    print(f"ä¸‹è½½å¤±è´¥: {error}")

# ä¸‹è½½åº”ç”¨æ›´æ–°
if app_update and app_update.get("has_update"):
    update_manager.download_app_update(
        app_update["update_url"],
        progress_callback=progress_callback,
        error_callback=error_callback
    )

# ä¸‹è½½æ¨¡å‹æ›´æ–°
for model_name, update_info in model_updates.items():
    if update_info.get("has_update"):
        update_manager.download_model_update(
            model_name,
            update_info["url"],
            progress_callback=progress_callback,
            error_callback=error_callback
        )
```

### é…ç½®æ–‡ä»¶æ ¼å¼ (update_config.json)
```json
{
  "version_url": "https://your-cdn.com/version.json",
  "app_name": "Aithon",
  "current_version": "1.1.0",
  "update_check_interval": 3600,
  "auto_download": false,
  "backup_before_update": true,
  "mirror_urls": [
    "https://mirror1.example.com/",
    "https://mirror2.example.com/"
  ]
}
```

## ğŸš€ å®Œæ•´éƒ¨ç½²æµç¨‹

### 1. å¼€å‘è€…ç«¯ - æ„å»ºæ›´æ–°åŒ…

```bash
# 1. å‡†å¤‡åº”ç”¨ç›®å½•
mkdir -p ./app_release
cp -r ./src ./app_release/
cp main.py ./app_release/

# 2. æ„å»ºæ›´æ–°åŒ…
python -m src.utils.UpdateBuilder ./app_release 1.2.0 \
    --changelog "æ–°å¢AIæ¨¡å‹ç®¡ç†åŠŸèƒ½" \
    --previous 1.1.0 \
    --output ./releases

# 3. ä¸Šä¼ åˆ°CDN
# å°† releases/ ç›®å½•ä¸‹çš„æ–‡ä»¶ä¸Šä¼ åˆ°ä½ çš„CDNæˆ–OSS
```

### 2. æœåŠ¡å™¨ç«¯ - é…ç½®æ›´æ–°æº

```json
// version.json (æ”¾åœ¨CDNæ ¹ç›®å½•)
{
  "app_version": "1.2.0",
  "app_update_url": "https://your-cdn.com/app_1.2.0.zip",
  "app_size": 52428800,
  "changelog": "æ–°å¢AIæ¨¡å‹ç®¡ç†åŠŸèƒ½",
  "models": {
    "qwen2.5-coder-1.5b-q5_k_m": {
      "version": "2025-01-15",
      "url": "https://your-cdn.com/models/qwen2.5-coder-1.5b-q5_k_m.gguf",
      "size": 1100000000,
      "description": "é»˜è®¤æ¨èæ¨¡å‹"
    }
  }
}
```

### 3. å®¢æˆ·ç«¯ - é›†æˆæ›´æ–°åŠŸèƒ½

```python
# åœ¨åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥æ›´æ–°
from src.utils.UpdateManager import update_manager

def check_for_updates():
    """æ£€æŸ¥æ›´æ–°"""
    try:
        # æ£€æŸ¥åº”ç”¨æ›´æ–°
        app_update = update_manager.check_app_update()
        if app_update and app_update.get("has_update"):
            show_update_dialog(app_update)
        
        # æ£€æŸ¥æ¨¡å‹æ›´æ–°
        model_updates = update_manager.check_model_update()
        if any(info.get("has_update") for info in model_updates.values()):
            show_model_update_dialog(model_updates)
            
    except Exception as e:
        print(f"æ£€æŸ¥æ›´æ–°å¤±è´¥: {e}")

def show_update_dialog(app_update):
    """æ˜¾ç¤ºæ›´æ–°å¯¹è¯æ¡†"""
    # è¿™é‡Œé›†æˆåˆ°ä½ çš„UIä¸­
    print(f"å‘ç°æ–°ç‰ˆæœ¬ {app_update['remote_version']}")
    print(f"æ›´æ–°å†…å®¹: {app_update['changelog']}")
    
    # ç”¨æˆ·ç¡®è®¤åå¼€å§‹ä¸‹è½½
    if user_confirms_update():
        download_and_apply_update(app_update)

def download_and_apply_update(app_update):
    """ä¸‹è½½å¹¶åº”ç”¨æ›´æ–°"""
    def progress_callback(url, progress, downloaded, total):
        update_progress_bar(progress)
    
    def error_callback(error):
        show_error_message(f"æ›´æ–°å¤±è´¥: {error}")
    
    # åˆ›å»ºå¤‡ä»½
    if update_manager.update_config.get("backup_before_update"):
        update_manager.create_backup()
    
    # ä¸‹è½½æ›´æ–°
    update_manager.download_app_update(
        app_update["update_url"],
        progress_callback=progress_callback,
        error_callback=error_callback
    )
```

## ğŸ› ï¸ é«˜çº§åŠŸèƒ½

### 1. è‡ªå®šä¹‰å¿½ç•¥æ–‡ä»¶
```python
builder = UpdateBuilder("./app")
builder.ignore_patterns.update({
    "*.tmp",
    "debug_*",
    "test_*"
})
```

### 2. å¤§æ–‡ä»¶åˆ†å—ä¸‹è½½
```python
# å¤§æ–‡ä»¶ä¼šè‡ªåŠ¨åˆ†å—ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ 
# æ¯ä¸ªåˆ†å—50MBï¼Œå¯ä»¥å¹¶è¡Œä¸‹è½½
```

### 3. å¤šé•œåƒæ”¯æŒ
```python
update_manager.update_config["mirror_urls"] = [
    "https://cdn1.example.com/",
    "https://cdn2.example.com/",
    "https://cdn3.example.com/"
]
```

### 4. æ–‡ä»¶å®Œæ•´æ€§éªŒè¯
```python
# ä¸‹è½½å®Œæˆåè‡ªåŠ¨éªŒè¯
is_valid = update_manager.verify_file_integrity(
    "downloaded_file.zip",
    "expected_hash_value"
)
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. æ›´æ–°çŠ¶æ€ç›‘æ§
```python
# è·å–æ›´æ–°çŠ¶æ€
status = update_manager.get_update_status()
print(f"åº”ç”¨æ›´æ–°: {status['app_update']}")
print(f"æ¨¡å‹æ›´æ–°: {status['model_updates']}")
print(f"æœ€åæ£€æŸ¥: {status['last_check']}")
```

### 2. æœ¬åœ°ç‰ˆæœ¬ä¿¡æ¯
```python
# è·å–æœ¬åœ°ç‰ˆæœ¬ä¿¡æ¯
local_info = update_manager.get_local_version_info()
print(f"å½“å‰ç‰ˆæœ¬: {local_info['app_version']}")
print(f"å·²å®‰è£…æ¨¡å‹: {list(local_info['models'].keys())}")
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ä¸‹è½½å¤±è´¥**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - å°è¯•ä½¿ç”¨ä¸åŒçš„é•œåƒæº
   - æ£€æŸ¥CDNé…ç½®

2. **æ–‡ä»¶éªŒè¯å¤±è´¥**
   - é‡æ–°ä¸‹è½½æ–‡ä»¶
   - æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å®Œæ•´
   - éªŒè¯å“ˆå¸Œå€¼æ˜¯å¦æ­£ç¡®

3. **æ›´æ–°åº”ç”¨å¤±è´¥**
   - æ£€æŸ¥æ–‡ä»¶æƒé™
   - ç¡®ä¿åº”ç”¨å·²å…³é—­
   - ä»å¤‡ä»½æ¢å¤

### è°ƒè¯•æ¨¡å¼
```python
import logging
logging.basicConfig(level=logging.DEBUG)

# å¯ç”¨è¯¦ç»†æ—¥å¿—
update_manager.debug_mode = True
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **å¹¶è¡Œä¸‹è½½**: å¤§æ–‡ä»¶åˆ†å—å¯ä»¥å¹¶è¡Œä¸‹è½½
2. **æ–­ç‚¹ç»­ä¼ **: æ”¯æŒä¸‹è½½ä¸­æ–­åç»§ç»­
3. **å¢é‡æ›´æ–°**: åªä¸‹è½½å˜åŒ–çš„æ–‡ä»¶
4. **é•œåƒåŠ é€Ÿ**: å¤šé•œåƒæºæé«˜ä¸‹è½½é€Ÿåº¦
5. **æœ¬åœ°ç¼“å­˜**: é¿å…é‡å¤ä¸‹è½½ç›¸åŒæ–‡ä»¶

## ğŸ”’ å®‰å…¨è€ƒè™‘

1. **æ–‡ä»¶éªŒè¯**: æ‰€æœ‰ä¸‹è½½çš„æ–‡ä»¶éƒ½ä¼šéªŒè¯å“ˆå¸Œå€¼
2. **HTTPS**: å»ºè®®ä½¿ç”¨HTTPSä¼ è¾“
3. **å¤‡ä»½æœºåˆ¶**: æ›´æ–°å‰è‡ªåŠ¨åˆ›å»ºå¤‡ä»½
4. **æƒé™æ§åˆ¶**: é™åˆ¶æ›´æ–°æ–‡ä»¶çš„è®¿é—®æƒé™

---

è¿™ä¸ªå¢é‡æ›´æ–°ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„åº”ç”¨å’Œæ¨¡å‹æ›´æ–°è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒå›½å†…ç½‘ç»œç¯å¢ƒï¼Œå…·æœ‰è‰¯å¥½çš„å®¹é”™æ€§å’Œç”¨æˆ·ä½“éªŒã€‚
